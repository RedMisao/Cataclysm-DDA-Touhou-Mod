[
  {
    "id": "touhou_everything_eoc",
    "type": "effect_on_condition",
    "eoc_type": "SCENARIO_SPECIFIC",
    "effect": [
      {
        "run_eocs": [
          {
            "id": "vampire_bloodthirst_start",
            "condition": { "u_has_trait": "VAMPIRE_SPECIES" },
            "effect": [
              { "math": [ "u_vitamin('hblood_vitamin')", "=", "648 + rand(144)" ] }
            ],
            "//": "Adds hblood_vitamin if the player is a VAMPIRE_SPECIES plus a smaller random amount, see vampire_bloodthirst_eoc below"
          },
          {
            "id": "kokoro_stance_set",
            "condition": { "u_has_trait": "PROF_KOKORO" },
            "effect": [
              { "math": [ "var_kokoro_stance", "=", "1" ] },
              { "math": [ "var_kokoro_mask", "=", "rand(3)" ] },
              { "math": [ "var_kokoro_unstable_rnd", "=", "rand(1)" ] },
              { "run_eocs": [ "kokoro_mask_eocs" ] },
              { "run_eocs": [ "kokoro_timer_eoc" ] }
            ],
            "//2": "The first EOC runs the default condition for Kokoro: 'base' stance plus random mask",
            "//3": "The second EOC runs the timer for the mask duration and automatic rotation"
          }
        ]
      }
    ]
  },
  {
    "id": "wield_weapon_dmg_eoc",
    "type": "effect_on_condition",
    "eoc_type": "EVENT",
    "required_event": "character_wields_item", 
    "effect": [ 
      {
        "u_run_inv_eocs": "all",
        "search_data": [ { "wielded_only": true } ],
        "true_eocs": [
          {
            "id": "wield_weapon_dmg_eoc2",
            "effect": [
              { "math": [ "var_melee_bash_dmg", "=", "n_melee_damage('bash')" ] },
              { "math": [ "var_melee_cut_dmg", "=", "n_melee_damage('cut')" ] },
              { "math": [ "var_melee_stab_dmg", "=", "n_melee_damage('stab')" ] },
              { "math": [ "var_melee_all_dmg", "=", "n_melee_damage('ALL')" ] },
              { "math": [ "var_melee_phys_dmg", "=", "var_melee_bash_dmg + var_melee_cut_dmg + var_melee_stab_dmg" ] },
              { "math": [ "var_gun_dmg", "=", "n_gun_damage('ALL')" ] }
            ]
          }
        ]
      }
    ],
    "//": "Thank you so much andrei8l for #71234 !!!",
    "//2": "Note: this is automatic but only detects wielding/unwielding actions, things like 'type: transform' from use_action don't update the values. If this becomes a problem update the value check every time the spell is cast"
  },
  {
    "id": "soulshard_eoc",
    "type": "effect_on_condition",
    "eoc_type": "EVENT",
    "required_event": "character_kills_monster",
    "condition": {
      "and": [ 
        { 
          "or": [ 
            { "u_has_trait": "KASHA_SPECIES" }, 
            { "u_has_trait": "KASHA_SPECIES_active" }
          ]
        },
        { 
          "or": [ 
            { "npc_has_species": "FERAL" }, 
            { "npc_has_species": "FUNGUS" }, 
            { "npc_has_species": "HUMAN" }, 
            { "npc_has_species": "NETHER" }, 
            { "npc_has_species": "ZOMBIE" } 
          ] 
        } 
      ]
    },
    "effect": [ 
      { "u_message": "soulshard_eoc 1" },
      { "u_spawn_item": "soul_shard_item", "count": 1, "suppress_message": true },
      { "u_cast_spell": { "id": "soulshard_spell" }, "targeted": false }
    ],
    "//": "Simple EOC checks when a Kasha kills anything, if it's humanoid or close enough it casts the subspell, which runs a centered-EOC to grant the item",
    "//2": "The u_spawn_item requires the target (victim) to be next to the caster else it doesn't proc, so a subspell is required to 'center' the EOC on the caster",
    "//3": "WIP. Cap this at 16",
    "//4": "WIP. This randomly does not proc, figure out why"
  },
  {
    "id": "soulshard_spell",
    "type": "SPELL",
    "name": { "str": "Soulshard (spell)" },
    "description": "Spell casted automatically when gaining a soulshard",
    "spell_class": "NONE",
    "valid_targets": [ "self" ],
    "effect": "effect_on_condition",
    "effect_str": "soulshard_spell_eoc",
    "shape": "blast",
    "min_aoe": 20,
    "max_aoe": 20,
    "max_level": 1,
    "difficulty": -10,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_EXPLOSION_SFX", "NO_FAIL" ]
  },
  {
    "id": "soulshard_spell_eoc",
    "type": "effect_on_condition",
    "effect": [ 
        { "u_message": "soulshard_spell_eoc 2" },
        { "u_spawn_item": "soul_shard_item", "count": 1, "suppress_message": true }
    ]
  },
  {
    "id": "kokoro_morale_eoc",
    "type": "effect_on_condition",
    "recurrence": "1 s",
    "condition": {
      "and": [
        { "u_has_trait": "PROF_KOKORO" },
        { "not": { "math": [ "u_val('morale')", "==", "0" ] } }
      ]
    },
    "deactivate_condition": { "not": { "u_has_trait": "PROF_KOKORO" } },
    "effect": [
      {
        "run_eocs": [
          {
            "id": "kokoro_morale_add",
            "condition": { "math": [ "u_val('morale')", "<", "0" ] },
            "effect": [ 
                { "math": [ "u_val('morale')", "+=", "1" ] },
                { "math": [ "var_kokoro_instability", "+=", "1" ] },
                { "math": [ "u_val('mana')", "+=", "2" ] }
            ]
          },
          {
            "id": "kokoro_morale_remove",
            "condition": { "math": [ "u_val('morale')", ">", "0" ] },
            "effect": [ 
                { "math": [ "u_val('morale')", "-=", "1" ] },
                { "math": [ "var_kokoro_instability", "+=", "1" ] },
                { "math": [ "u_val('mana')", "+=", "2" ] }
            ]
          }
        ]
      }
    ],
    "//": "Turns morale into mana, only for Kokoro, deactivates if her morale is zero"
  },
  {
    "id": "kokoro_timer_eoc",
    "type": "effect_on_condition",
    "recurrence": "15 s",
    "condition": { "u_has_trait": "PROF_KOKORO" },
    "effect": [ 
        { "math": [ "var_kokoro_timer", "-=", "15" ] },
        { "run_eocs": [ "kokoro_instability_check_eoc" ] }
    ],
    "deactivate_condition": { "not": { "u_has_trait": "PROF_KOKORO" } },
    "//": "Reduces var_kokoro_timer every 15 s and checks if she has enough instability"
  },
  {
    "id": "celestial_stance_check",
    "type": "effect_on_condition",
    "recurrence": "1 s",
    "condition": {
      "and": [
        { "u_has_trait": "celestial_stance_mut" },
        { "not": { "u_using_martial_art": "style_celestial_brawling_tenko" } }
      ]
    },
    "deactivate_condition": { "not": { "u_has_trait": "celestial_stance_mut" } },
    "effect": [ 
      { "u_lose_trait": "celestial_stance_mut" }
    ],
    "//": "This removes the knockback and knockdown immunity of Tenko's MA if she's not using it"
  },
  {
    "id": "mokou_death_eoc",
    "type": "effect_on_condition",
    "eoc_type": "PREVENT_DEATH",
    "condition": {
      "and": [
        { "u_has_trait": "PROF_MOKOU" },
        { "math": [ "var_mokoudeath", "<", "rand(504)" ] }
      ]
    },
    "effect": [
      { "u_message": "Too bad you can't actually die for good.", "popup": true },
      { "u_lose_trait": "PORTAL_RESURRECTION" },
      { "u_add_effect": "mokou_resurrectcleanse", "duration": "6 s" },
      { "u_add_effect": "mokou_resurrectpain", "duration": "168 hours" },
      { "math": [ "u_hp('ALL')", "=", "100" ] },
      { "u_cast_spell": { "id": "mokou_resurrectionphoenix" }, "targeted": false },
      { "math": [ "var_mokoudeath", "+=", "168" ] },
      { "math": [ "u_val('fatigue')", "=", "0" ] },
      { "math": [ "u_val('mana')", "=", "800" ] },
      { "math": [ "u_pain()", "=", "0" ] }
    ],
    "//": "This eoc enables PROF_MOKOU to resurrect/revive. Every time Mokou dies she gets var_mokoudeath, which lasts for 7 days and decreases slowly over time. Every time she revives, the value is checked vs a random number, so the more she dies in a short time the harder it is for her to not give up for real",
    "//2": "ANY trait that revives the character should be lost every time Mokou dies. So far, it's just PORTAL_RESURRECTION "
  },
  {
    "id": "mokou_resurrect_counter_eoc",
    "type": "effect_on_condition",
    "recurrence": "1 hour",
    "condition": {
      "and": [
        { "u_has_trait": "PROF_MOKOU" },
        { "math": [ "var_mokoudeath", ">", "0" ] }
      ]
    },
    "deactivate_condition": { "math": [ "var_mokoudeath", "<=", "0" ] },
    "effect": [ 
        { "math": [ "var_mokoudeath", "-=", "1" ] } 
    ],
    "//": "Reduces var_mokoudeath over time"
  },
  {
    "id": "vampire_bloodthirst_eoc",
    "type": "effect_on_condition",
    "recurrence": "1 hour",
    "condition": { "u_has_trait": "VAMPIRE_SPECIES" },
    "effect": [
      {
        "run_eocs": [
          {
            "id": "vampire_bloodthirst_lowerlimit",
            "condition": { "math": [ "u_vitamin('hblood_vitamin')", "<=", "0" ] },
            "effect": [
              { "math": [ "u_vitamin('hblood_vitamin')", "=", "0" ] }
            ]
          },
          {
            "id": "vampire_bloodthirst_veryhigh",
            "condition": { "math": [ "u_vitamin('hblood_vitamin')", "<", "144" ] },
            "effect": [
              { "u_lose_effect": "bloodthirst_low" },
              { "u_lose_effect": "bloodthirst_medium" },
              { "u_lose_effect": "bloodthirst_high" },
              { "u_add_effect": "bloodthirst_veryhigh", "duration": "1 hour" }
            ]
          },
          {
            "id": "vampire_bloodthirst_high",
            "condition": {
              "and": [
                { "math": [ "u_vitamin('hblood_vitamin')", ">=", "145" ] },
                { "math": [ "u_vitamin('hblood_vitamin')", "<", "288" ] }
              ]
            },
            "effect": [
              { "u_lose_effect": "bloodthirst_low" },
              { "u_lose_effect": "bloodthirst_medium" },
              { "u_lose_effect": "bloodthirst_veryhigh" },
              { "u_add_effect": "bloodthirst_high", "duration": "1 hour" }
            ]
          },
          {
            "id": "vampire_bloodthirst_medium",
            "condition": {
              "and": [
                { "math": [ "u_vitamin('hblood_vitamin')", ">=", "289" ] },
                { "math": [ "u_vitamin('hblood_vitamin')", "<", "432" ] }
              ]
            },
            "effect": [
              { "u_lose_effect": "bloodthirst_low" },
              { "u_lose_effect": "bloodthirst_high" },
              { "u_lose_effect": "bloodthirst_veryhigh" },
              { "u_add_effect": "bloodthirst_medium", "duration": "1 hour" }
            ]
          },
          {
            "id": "vampire_bloodthirst_low",
            "condition": {
              "and": [
                { "math": [ "u_vitamin('hblood_vitamin')", ">=", "433" ] },
                { "math": [ "u_vitamin('hblood_vitamin')", "<", "576" ] }
              ]
            },
            "effect": [
              { "u_lose_effect": "bloodthirst_medium" },
              { "u_lose_effect": "bloodthirst_high" },
              { "u_lose_effect": "bloodthirst_veryhigh" },
              { "u_add_effect": "bloodthirst_low", "duration": "1 hour" }
            ]
          },
          {
            "id": "vampire_bloodthirst_verylow",
            "condition": { "and": [ { "math": [ "u_vitamin('hblood_vitamin')", ">=", "577" ] } ] },
            "effect": [
              { "u_lose_effect": "bloodthirst_low" },
              { "u_lose_effect": "bloodthirst_medium" },
              { "u_lose_effect": "bloodthirst_high" },
              { "u_lose_effect": "bloodthirst_veryhigh" }
            ]
          },
          {
            "id": "vampire_bloodthirst_upperlimit",
            "condition": { "math": [ "u_vitamin('hblood_vitamin')", ">=", "792" ] },
            "effect": [
              { "math": [ "u_vitamin('hblood_vitamin')", "=", "792" ] }
            ]
          }
        ]
      }
    ],
    "//": "hblood_vitamin decays 1 point every 20 min, so 72 points equals 24 hours of not consuming human blood/flesh",
    "//2": "Boundaries for each blood thirst tier are: 0 (including excess) - 24 h (no thirst), 1 - 3 days (low), 3 - 5 days (medium), 5 - 7 days (high), >7 days (veryhigh)",
    "//3": "This means that, assuming the little vampires start at the lower boundary of day 0 (648), they can go up to 24 hours with no thirst (reach 576), and then get increased thirst every two days, peaking at one week (144) without consumption"
  }
]
